name: Deploy PR to Remote Server

on:
  workflow_run:
    workflows: ["Build and test"]
    types:
      - completed
    branches-ignore:
      - main

concurrency:
  group: deploy-pr-${{ github.event.workflow_run.head_branch }}
  cancel-in-progress: true

env:
  REGISTRY: ghcr.io
  APP_IMAGE_NAME: ${{ github.repository }}
  NGINX_IMAGE_NAME: ${{ github.repository }}-nginx

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: deploy-web
    # Only run if the build workflow succeeded and it was a PR
    if: >
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.event == 'pull_request'

    steps:
      - name: Get PR number
        id: pr
        run: |
          PR_NUMBER=$(echo "${{ github.event.workflow_run.head_branch }}" | grep -oP '^\d+(?=/merge$)' || echo "")
          if [ -z "$PR_NUMBER" ]; then
            # If not in format "123/merge", extract PR number from the head_branch
            # The branch name for PRs is usually the PR branch name
            # We'll use the GitHub API to find the PR number
            PR_NUMBER=$(gh pr list --repo ${{ github.repository }} --head "${{ github.event.workflow_run.head_branch }}" --json number --jq '.[0].number')
          fi
          echo "number=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "Deploying PR #$PR_NUMBER"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to remote server
        run: |
          ssh -i ~/.ssh/deploy_key -p ${{ secrets.SSH_PORT || 22 }} ${{ secrets.SSH_USERNAME }}@${{ secrets.SSH_HOST }} ${{ steps.pr.outputs.number }}

      - name: Cleanup SSH
        if: always()
        run: |
          rm -f ~/.ssh/deploy_key

      - name: Comment on PR
        if: steps.pr.outputs.number != ''
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ steps.pr.outputs.number }};
            const baseDomain = '${{ secrets.BASE_DOMAIN || 'staging.dev' }}';

            // Find which staging slot was assigned
            // This is a simple estimate - the script handles the actual assignment
            const stagingSlot = (prNumber % 5);
            const deployUrl = `https://staging${stagingSlot}.${baseDomain}`;

            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: `ðŸš€ **PR deployment started!**\n\nYour changes are being deployed. Check the deployment logs for the final URL.\n\nExpected URL (may vary): ${deployUrl}\n\n**Images:**\n- App: \`${{ env.REGISTRY }}/${{ env.APP_IMAGE_NAME }}:pr-${prNumber}\`\n- Nginx: \`${{ env.REGISTRY }}/${{ env.NGINX_IMAGE_NAME }}:pr-${prNumber}\``
            });
