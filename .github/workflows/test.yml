name: Tests

on:
  workflow_run:
    workflows: ["Build and Push Docker Images"]
    types:
      - completed

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: read

    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Pull or build Docker image
      run: |
        # Try to pull the pre-built image from the registry
        if docker pull ghcr.io/${{ github.repository }}:latest; then
          echo "Using pre-built image from registry"
          docker tag ghcr.io/${{ github.repository }}:latest kompass:test
        else
          echo "Building image from scratch (registry image not available)"
          cd docker/test
          docker buildx build \
            --load \
            -t kompass:test \
            -f Dockerfile \
            ../../
        fi

    - name: Run tests
      run: make test-only

    - name: Check coverage
      run: |
        COVERAGE=$(python3 -c "import json; data=json.load(open('docker/test/htmlcov/coverage.json')); print(data['totals']['percent_covered'])")
        echo "Coverage: ${COVERAGE}%"
        if (( $(echo "$COVERAGE < 100" | bc -l) )); then
          echo "Error: Coverage is ${COVERAGE}%, must be 100%"
          exit 1
        fi
