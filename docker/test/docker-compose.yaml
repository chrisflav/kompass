version: "3.9"

services:
    master:
        image: kompass:test
        build:
            context: ./../../
            dockerfile: docker/test/Dockerfile
        env_file: docker.env
        environment:
          - KOMPASS_CONFIG_DIR_PATH=/app/config/
          - DJANGO_SETTINGS_MODULE=jdav_web.settings
          - DJANGO_TEST_KEEPDB=$DJANGO_TEST_KEEPDB
          - DJANGO_TEST_VERBOSITY=$DJANGO_TEST_VERBOSITY
        depends_on:
          - redis
          - cache
          - db
        entrypoint: /app/docker/test/entrypoint-master.sh
        volumes:
          - ./config:/app/config:ro
          - type: bind
            source: ./htmlcov/
            target: /app/jdav_web/htmlcov/

    cache:
        restart: always
        image: memcached:alpine

    redis:
        restart: always
        image: redis:6-alpine

    db:
        restart: always
        image: mariadb
        volumes:
          - ./db:/var/lib/mysql
          - ./provision/mysql/init:/docker-entrypoint-initdb.d
        env_file: docker.env
